<div id="loginContainer">
	<div class="form-signin">
		<h2 class="form-signin-heading">Enter a player name</h2>
		<input type="text" id="inputPlayerName" class="form-control" placeholder="Player Name" required autofocus>
		<button class="btn btn-lg btn-primary btn-block" id="join">Join</button>
	</div>
</div>
<script>
	var playerName;
	var secret;

	$('#join').click(function(clickEvent) {
		if(!$('#inputPlayerName').val()) {
			alert('Please enter a name.');
			return;
		}
		
		disable('Joining...', $('#join'));
		
		var tplayerName = $('#inputPlayerName').val();
		var tsecret = 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
				var r = Math.random()*16|0, v = c == 'x' ? r : (r&0x3|0x8);
				return v.toString(16);
			});
	
		database.ref('game/input/lobby/request/' + tplayerName).set({
			name: tplayerName
		});
		
		var tryHeartBeat = setInterval(function() {
			database.ref('game/input/lobby/heartbeat/' + tplayerName).set({
				name: tplayerName,
				secret: tsecret
			});
		}, 1000);
	
		var loginTimeout = setTimeout(function() {
			alert("This name is currently unavailable. Sorry, try again!");
			enable('Join', $('#join'));
			clearInterval(tryHeartBeat);
			loadPage('login.html');		
		}, 5500);
		
		database.ref('game/lobby/players/' + tplayerName).on('value', function(snapshot) {
			var player = snapshot.val();
			
			if(!player) {
				return;
			}
			
			if(player.secretCheck == tsecret.substring(tsecret.length - 6)) {
				clearInterval(tryHeartBeat);
				clearTimeout(loginTimeout);		

				playerName = tplayerName;
				secret = tsecret;
				
				// keep alive		
				database.ref('game/lobby/players/' + playerName + '/heartBeat').on('value', function(snapshot) {
					var heartBeat = snapshot.val();
					if(heartBeat) {
						database.ref('game/input/lobby/heartbeat/' + tplayerName).set({
							name: playerName,
							secret: secret
						});
					}
				});
				
				if(!lobbyEntered) {
					lobbyEntered = true;
					loadPage('lobby.html');
				}
			}
		});
		
	});
</script>