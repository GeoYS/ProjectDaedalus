<html>

<header>
	<script src="jquery-2.2.4.min.js"></script>
	<script src="knockout-3.4.0.js"></script>
	<script src="https://www.gstatic.com/firebasejs/live/3.0/firebase.js"></script>
	<script>
	  // Initialize Firebase
	  var config = {
		apiKey: "AIzaSyDjujhrawjD7SYiQV9axXI31yAySAC_Zfw",
		authDomain: "project-828640652417633159.firebaseapp.com",
		databaseURL: "https://project-828640652417633159.firebaseio.com",
		storageBucket: "",
	  };
	  firebase.initializeApp(config);
	</script>
	<style>
	html {
		overflow: hidden; 
	}
	body {
		margin: 0;
	}
	.tile {
		width: 100px;
		height: 100px;
		float: left;
	}
	.grassland {
		background-color: lightgreen;
	}
	.water {
		background-color: lightblue;
	}
	</style>
</header>
<body>
	<div id="main" style="overflow: hidden">
		<div id="map" style="z-index: -1; position: absolute;">	
		</div>
		<p id="mapDimensions"></p>
		<p id="numPlayers">Number of players:</p>
		<p id="playersInLobby">Players in lobby: </p>
		<input type="text" id="name"></input>
		<input type="button" onclick="join()" value="Join">
	</div>
	<script type="text/javascript">
		var database = firebase.database();
	
		firebase.auth().signInAnonymously().catch(function(error) {
			alert("ERROR IN AUTHENTICATION!!!");
		});
		var numPlayers = database.ref('game/lobby/numPlayers').on('value', function(snapshot) {
			var numPlayers = snapshot.val();
			$('#numPlayers').html('Number of players: ' + numPlayers);
		});
		
		var playersInLobby = database.ref('game/lobby/players').on('child_added', function(snapshot) {
			var newPlayer = snapshot.val();
			$('#playersInLobby').append(' ' + newPlayer.name);
		});
		
		function join() {
			var numPlayers = database.ref('game/lobby/request/' + $('#name').val()).set({
				name: $('#name').val()
			});
			$('#name').val('');
		}
		
		database.ref('game/world/map').on('value', function(snapshot) {
			var map = snapshot.val();
			var tilesWide = map['tilesWide'];
			var tilesHigh = map['tilesHigh'];
			var mapDiv = $('#map');
			
			$('#mapDimensions').html('Map dimensions: ' + tilesWide + 'x' + tilesHigh);
			
			for(var y = 0; y < tilesHigh; y ++) {
				var row = 'row' + y;
				$('#map').append('<div id=\'' + row + '\'></div>');
				$('#' + row).width(tilesWide * 100);
				
				for(var x = 0; x < tilesWide; x ++) {
					var coord = x + ',' + y;
					$('#' + row)
						.append(
							'<div class=\'tile ' + map['tiles'][coord]['properties']['tileType'] + '\' ' + 'id=\'' + coord + '\'></div>');
				}
			}
		});
		
		var lastX, lastY;
		var isDragging = false;
		
		$(document)
		.mousedown(function(event) {
			lastX = event.pageX;
			lastY = event.pageY;
			isDragging = true;
		})
		.mousemove(function(event) {
			if(isDragging) {
				var map = $('#map');
				var oldOffset = map.offset();
				var deltaX = event.pageX - lastX;
				var deltaY = event.pageY - lastY;
				
				if(deltaX < -300) {
					deltaX = -300;
				}
				if(deltaX > 3300) {
					deltaX = 3300;
				}
				
				if(deltaY < -300) {
					deltaY = -300;
				}
				if(deltaY > 3300) {
					deltaY = 3300;
				}
				
				map.offset({
					top: oldOffset['top'] + deltaY,
					left: oldOffset['left'] + deltaX
				});
				
				lastX = event.pageX;			
				lastY = event.pageY;
				
				isDragging = true;
			}
		})
		.mouseup(function(event) {
			isDragging = false;
		});
	</script>
</body>

</html>